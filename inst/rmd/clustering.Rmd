---
title: "pathfindr - Seperate Pathways into Clusters"
runtime: shiny
output: html_document
params:
  mat: ""
  df: ""
---

This shiny app allows the user to dynamically select a cut-off value for seperating the pathways into clusters via partitioning of the dendrogram. 

The plot displays the hierarchical clustering dendrogram and the chosen cut-off, i.e. the height at which the tree is cut.

The table displays the representative pathways chosen for each cluster, based on smallest `lowest p value`s. A csv file containing all the pathways with their cluster memberships is also saved in the current directory.

```{r hclust, echo=F}
res_df <- params$df
PWD <- params$mat

dend <- hclust(as.dist(PWD), method = "average")

shiny::sidebarPanel(
  shiny::downloadButton("downloadData", "Get Pathways w\\ Cluster Info"))

shiny::inputPanel(
  shiny::sliderInput("cut_off", label = "Cut-off value for the dendrogram:",
              min = 0, max = max(dend$height), value = 0.5, step = 0.1)
  # shiny::numericInput("cut_off", label = "", value = 0.5, min = 0, 
  #                     max = max(dend$height)+0.1, step = 0.1)
)

shiny::renderPlot({
  plot(dend, hang = -1, xlab="", ylab = "PD", sub = "")
  abline(h = input$cut_off, col = "red")
})

shiny::renderTable({
  clusters <- cutree(dend, h = input$cut_off)
  clu_df <- as.data.frame(clusters)
  clu_df$KEGG_ID <- rownames(clu_df)
  clu_df$Pathway <- res_df$Pathway[match(clu_df$KEGG_ID, res_df$ID)]
  clu_df <- clu_df[,c(2,3,1)]
  clu_df$p_value <- res_df$lowest_p[match(clu_df$KEGG_ID, res_df$ID)]
  clu_df <- clu_df[order(clu_df$p_value), ]

  res_df$Cluster <- clu_df[match(res_df$ID, clu_df$KEGG_ID), 3]
  tmp <- res_df$lowest_p
  names(tmp) <- res_df$ID
  tmp <- tapply(tmp, res_df$Cluster, function(x) names(x)[which.min(x)])
  res_df$Representative <- ifelse(res_df$ID %in% tmp, "Representative", "Member")
  # write.csv(res_df, paste0(input$cut_off, "clusters.csv"), row.names = F)

  clu_df <- clu_df[!duplicated(clu_df$clusters),]
  clu_df$p_value <- format(clu_df$p_value, digits = 2)
  clu_df
})

output$downloadData <- downloadHandler(
    filename = function() {
      paste0("clusters_", input$cut_off, ".csv")
    },
    content = function(file) {
      write.csv(res_df, file, row.names = FALSE)
    }
  )

```
